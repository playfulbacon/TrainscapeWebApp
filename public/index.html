<html>

<body>
  <h1>Trainscape</h1>
  <input type="text" id="roomCode" placeholder="ROOM CODE"
    style="display: block; width: 100%; margin-bottom: 10px; padding: 10px; text-transform: uppercase;"
    maxlength="4" />
  <button id="connect-button" title="Connect" style="width: 100%; height: 30px;">Connect</button>
  <button id="test-button" title="Test" style="width: 100%; height: 30px;">Broadcast To Room</button>
  <pre id="messages" style="height: 400px; overflow: scroll"></pre>

  <script>
    (function () {

      var roomCode = '';

      const ws = new WebSocket(location.origin.replace(/^http/, 'ws'));

      ws.onopen = () => {
        console.log('Connection opened!');
      }

      ws.onmessage = (message) => {
        var webAppMessage = JSON.parse(message.data);

        if (webAppMessage.roomCode.toLowerCase() == roomCode){
          showMessage(message.data);
        }
      }

      ws.onclose = function () {
        ws = null;
      }

      const connectBtn = document.querySelector('#connect-button');
      const testBtn = document.querySelector('#test-button');
      const messages = document.querySelector('#messages');
      const roomCodeInput = document.querySelector('#roomCode');

      connectBtn.onclick = function(){
        console.log("connect button pressed");

        roomCode =  document.querySelector('#roomCode').value.toLowerCase();
        var joinRequest = {
            messageType: 'ROOM_JOIN_REQUEST',
            roomCode: roomCode,
        };

        ws.send(JSON.stringify(joinRequest));
      }

      testBtn.onclick = function(){
        console.log("test button pressed");
        ws.send(JSON.stringify({messageType: "TEST", roomCode: roomCode}));
      }

      function showMessage(message) {
        messages.textContent += `\n\n${message}`;
        messages.scrollTop = messages.scrollHeight;
      }

    })();
  </script>
</body>

</html>